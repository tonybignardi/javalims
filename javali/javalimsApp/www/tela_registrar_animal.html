<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width">
        <meta charset="utf-8">
        <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection">
        <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link href="css/bootstrap.css" rel="stylesheet" media="screen">
        <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
        <link href="css/bootstrap-theme.css" rel="stylesheet" media="screen">
        <link type="text/css" rel="stylesheet" href="css/styles.css">
        <style>
            input[type="submit"]{
                background: none;
                border: none;
                font-style: normal;
                padding: 0px;
            }
            body{
                width:100%;
                height:100%;
            }
            nav-wrapper{
                height:5px;
            }
            row{
                height:70%;
            }
            @font-face {
                font-family: 'Material Icons';
                font-style: normal;
                font-weight: 400;
                src: local('Material Icons'), local('MaterialIcons-Regular'), url(fonts/materialfont.woff2) format('woff2');
            }
            label{
                font-size: 15px;
            }
            #label{
                font-size: 15px;
            }
            .material-icons {
                font-family: 'Material Icons';
                font-weight: normal;
                font-style: normal;
                font-size: 15px;
                line-height: 1;
                letter-spacing: normal;
                text-transform: none;
                display: inline-block;
                white-space: nowrap;
                word-wrap: normal;
                direction: ltr;
                -webkit-font-feature-settings: 'liga';
                -webkit-font-smoothing: antialiased;
            }
            #username1{
                font-size: 100%;
            }
            #username2{
                font-size: 100%;
            }
            .mapa{
                background-color: white;
                width: 100%;  
                height: 300px;
            }
            .collapsible{
                box-shadow: 0 5px 5px 0 rgba(0,0,0,0.0), 0 5px 5px 0 rgba(0,0,0,0);
            }
        </style>
    </head>
    <body>
        <!--<form method="post" id="adicionarRegistro" action="http://192.168.43.30/JavaliMS/registro_animal.php">-->
        <form method="post" id="adicionarRegistro">
            <div style="display: none;">
                <input id="email" type="hidden" name="usuarioEmail">
                <input id="senha" type="hidden" name="usuarioSenha">
                <input id="senha" type="hidden" name="usuarioLogin">
            </div>
            <div class="container-fluid" style="margin-top:10px">
                <ul class="collapsible" data-collapsible="accordion" style="margin: 0px;padding: 0px;width: 100%;border: transparent;background: transparent;">
                    <li style="background: transparent;border: transparent;">
                        <div style="background: transparent;border: transparent;padding: 0px;" class="collapsible-header" id="endereco"><b>Localizaçao<i class="mdi-navigation-arrow-drop-down right"></b></i></div>
                        <div class="form-group  collapsible-body col s12 m12 l12" id="enderecoBody">
                            <input name="registroAnimalGeoReferenciaCoordenadas" required placeholder="Coordenada Geográfica" id="registroAnimalGeoReferenciaCoordenadas" type="text" class="validate form-control">
                            <input name="registroAnimalGeoReferenciaCidade" required placeholder="Cidade" id="registroAnimalGeoReferenciaCidade" type="text" class="validate form-control">
                            <input name="registroAnimalGeoReferenciaBairro" required placeholder="Bairro ou Zona" id="registroAnimalGeoReferenciaBairro" type="text" class="validate form-control">
                            <input name="registroAnimalGeoReferenciaRua"  placeholder="Rua" id="registroAnimalGeoReferenciaRua" type="text" class="validate form-control">
                            <input name="registroAnimalGeoReferenciaNumero" required placeholder="Numero (Casa, apartamento, BR)" id="registroAnimalGeoReferenciaNumero" type="text" class="validate form-control">
                        </div>
                    </li>
                </ul>
                <div class="form-group  col s12 m12 l12" name="animalNome">
                    <label for="animal_nome"  id="label" style="text-align: left;" class="left">Animal</label>
                    <select  style="margin-bottom:15px;" id="animals" class="validate dropdown-menu-right form-control" name="animal_animalId"></select>
                </div>
                <div style="height: 10px;"></div>
                <div class="input-field col s12 m12 l12 form-group">
                    <input name="registroAnimalDataHora" required placeholder="Digite seu nome" id="dataHora" type="datetime-local" class="validate form-control" length="19">
                    <label class="active" id="label" for="dataHora" style="margin-left: -10px;">Data</label>
                </div>
                <div class="input-field col s12 m12 l12 form-group">
                    <textarea style="max-height: 30px;font-size: 15px;"  placeholder="Observações sobre o registro" id="obs" name="registroAnimalObs" type="text" class="validate materialize-textarea form-control" length="100"></textarea>
                    <label style="margin-top: 10px;margin-left: -10px;"  class="active" id="label" for="obs">Observações</label>
                </div>
                <div style="height: 10px;"></div>
                <div class="input-field col s12 m12 l12 form-group">
                    <input name="registroAnimalQtd" required placeholder="Digite a quantidade aproximada de animais" id="qtd" type="number" class="validate form-control" length="4" min="0">
                    <label class="active" id="label" for="qtd" style="margin-left: -10px;">Quantidade</label>
                </div>
                <div class="form-group col s12 m12 l12 ">
                    <label class="active left">Sexo predominante</label>
                    <select id="nivel_conta" name="registroAnimalSexo" class="dropdown-menu-right form-control">
                        <option value="M">Machos</option>
                        <option value="F">Fêmeas</option>
                    </select>
                </div>
                <div class="form-group col s12 m12 l12 ">
                    <label class="active left">Idade Aproximadade do(s) animal(s)</label>
                    <select id="nivel_conta" name="registroAnimalTempoVida" class="dropdown-menu-right form-control">
                        <option>Animais Adultos Apenas</option>
                        <option>Animais Jovêns Apenas</option>
                        <option>Animais Filhotes Apenas</option>
                        <option>Ambos</option>
                    </select>
                </div>
                <div style="height: 10px;"></div>
                <div class="input-field col s12 m12 l12 form-group">
                    <input name="registroAnimalFoto" required placeholder="Adicione uma foto para o registro" id="fotoAnimalLocal" type="url" class="validate form-control">
                    <label class="active" id="label" for="registroAnimalFoto" style="margin-left: -10px;">Foto do Registro</label>
                </div>
                <div class="form-group col s12 m12 l12">
                    <div style="float: left;width: 50%;">
                        <a style="margin: 0px;" href="#!" id="tirarFoto" onclick="tirarfoto()" class="waves-effect waves-light modal-trigger btn-floating btn-cadastro" ><i class="material-icons">camera</i></a>
                        <label style="margin: 0px;margin-left: 5px;" id="label">Tirar Foto</label>
                    </div>
                    <div style="width: 50%;float: right;">
                        <a id="addFoto" onclick="" style="margin: 0px;" class="waves-effect waves-light modal-trigger btn-floating btn-cadastro"><i class="material-icons">add</i></a>
                        <label style="margin: 0px;margin-left: 5px;" id="label">Foto Existente</label>
                    </div>
                </div>
                <img id="images" style="width: 80%;background: black;" src="">
                <div class="form-group col s12 m12 l12 ">
                    <label class="active left" style="margin-top: 50px;">Situação do(s) animal(s)</label>
                    <select id="situacoes" class="dropdown-menu-right form-control" name="situacaoAnimal_situacaoAnimalId">
                    </select>
                </div>
                <div class="form-group col s12 m12 l12 "><!--adicionarRegistro()-->
                    <input id="btn_salvar" type="submit"  style="margin-bottom: 20px;" onclick="" class="bt btn-cadastro waves-effect waves-teal btn" value="Adicionar Registro"/>
                    <a id="btn_cancelar"  style="margin-bottom: 20px;" href="index.html" class="btn btn-cadastro waves-effect">Cancelar</a>
                </div>
            </div>
        </form>
        <script type="text/javascript">
            var conexao = '', camera = false, gps = false, watchID = '';
            window.onload = function () {
                $('#obs').trigger('autoresize');
                $('#enderecoBody').toggle();
                $('#images').hide();
                e = new Date();
                var h = e.getHours() + '';
                var m = e.getUTCMinutes() + '';
                var s = '00';
                var y = e.getFullYear() + '';
                var mes = e.getMonth() + '';
                var d = e.getMonth() + '';
                if (h < 10) {
                    h = '0' + h;
                }
                if (m < 10) {
                    m = '0' + m;
                }
                if (mes < 10) {
                    mes = '0' + mes;
                }
                if (d < 10) {
                    d = '0' + d;
                }
                $('#dataHora').val(e.getFullYear() + "-" + mes + "-" + d + 'T' + h + ":" + m + ":" + s);
                try {
                    url = "";
                    json = JSON.parse(localStorage.getItem('servidor'));
                    url = json.ip;
                } catch (e) {
                    url = 'localhost';
                }
                $.ajax({
                    type: "POST",
                    url: "http://" + url + "/JavaliMS/registro_animal_consulta.php",
                    data: {animals: ''},
                    async: false,
                    dataType: "json",
                    success: function (json) {
                        animal_num = 0, linha = "";
                        for (var i = 0; i < json.length; i++) {
                            linha = linha + '<option class="validate form-control" style="display:block" id ="animal' + animal_num + '" value="' + json[animal_num][0] + '">' + json[animal_num][1] + '</option>';
                            $("#animals").html(linha);
                            animal_num++;
                        }
                        localStorage.setItem('animals', JSON.stringify(json));
                    }
                    , error: function (xhr, e, t) {
                        json = JSON.parse(localStorage.getItem('animals'));
                        try {
                            var animal_num = 0;
                            var linha = "";
                            for (var i = 0; i < json.length; i++) {
                                linha = linha + '<option class = "validate form-control" style ="display:block" id ="animal' + animal_num + '" value="' + json[animal_num][0] + '">' + json[animal_num][1] + '</option>';
                                $("#animals").html(linha);
                                animal_num++;
                            }
                        }
                        catch (e) {
                            alert('É necessario uma conexão com internet');
                        }
                    }
                });
                $.ajax({
                    type: "POST",
                    url: "http://" + url + "/JavaliMS/registro_animal_consulta.php",
                    data: {situacoes: ''},
                    async: false,
                    dataType: "json",
                    success: function (json) {
                        var situacao_num = 0, linha = "";
                        for (var i = 0; i < json.length; i++) {
                            linha = linha + '<option class = "validate form-control" style ="display:block" id ="situacao'
                                    + situacao_num + '" value="' + json[situacao_num][0] + '">' + json[situacao_num][1] + '</option>';
                            $("#situacoes").html(linha);
                            situacao_num++;
                        }
                        localStorage.setItem('situacoes', JSON.stringify(json));
                    }
                    , error: function (xhr, e, t) {
                        json = JSON.parse(localStorage.getItem('situacoes'));
                        try {
                            var situacao_num = 0;
                            var linha = "";
                            for (var i = 0; i < json.length; i++) {
                                linha = linha + '<option class = "validate form-control" style = "display:block" id ="situacao' + situacao_num + '" value="' + json[situacao_num][0] + '">' + json[situacao_num][1] + '</option>';
                                $("#situacoes").html(linha);
                                situacao_num++;
                            }
                        } catch (er) {
                            alert('É necessario uma conexão com internet');
                        }
                    }
                });
                if (navigator.camera) {
                    camera = true;
                }
                checkConnection();
            };
            if (navigator.geolocation) {
                gps = true;
                navigator.geolocation.watchPosition(geolocationSuccess, geolocationError, {timeout: 30000});
            }
            if (navigator.connection) {
                var networkState = navigator.connection.type;
                var states = {};
                states[Connection.UNKNOWN] = 'Unknown connection';
                states[Connection.ETHERNET] = 'Ethernet connection';
                states[Connection.WIFI] = 'WiFi connection';
                states[Connection.CELL_2G] = 'Cell 2G connection';
                states[Connection.CELL_3G] = 'Cell 3G connection';
                states[Connection.CELL_4G] = 'Cell 4G connection';
                states[Connection.CELL] = 'Cell generic connection';
                states[Connection.NONE] = 'No network connection'
                conexao = states[networkState];
                alert(conexao + '');
            }
            function checkConnection() {
                if (navigator.connection) {
                    var networkState = navigator.connection.type;
                    var states = {};
                    states[Connection.UNKNOWN] = 'Unknown connection';
                    states[Connection.ETHERNET] = 'Ethernet connection';
                    states[Connection.WIFI] = 'WiFi connection';
                    states[Connection.CELL_2G] = 'Cell 2G connection';
                    states[Connection.CELL_3G] = 'Cell 3G connection';
                    states[Connection.CELL_4G] = 'Cell 4G connection';
                    states[Connection.CELL] = 'Cell generic connection';
                    states[Connection.NONE] = 'No network connection'
                    conexao = states[networkState];
                    alert(conexao + '');
                }
            }
            function geolocationSuccess(position) {
                $("#registroAnimalGeoReferenciaCoordenadas").text(position.coords.latitude + ',' + position.coords.longitude);
                alert(position.coords.latitude + ',' + position.coords.longitude);
            }
            function geolocationError(error) {
                alert('Código: ' + error.code + '\n' + 'Menssagem: ' + error.message + '\n');
            }
            $(document).ready(function () {
                $("#dathora").datepicker({
                    showButtonPanel: true
                });
            });
            function adicionarRegistro() {
                Materialize.toast('Registro Adicionado com sucesso', 4000, 'rounded');
                open('index.html');
            }
            function tirarfoto() {
                if (camera == true) {
//                    navigator.camera.getPicture(onSuccess, onFail, {quality: 50, destinationType: Camera.DestinationType.FILE_URI});
                    navigator.camera.getPicture(onSuccess, onFail, {quality: 50, correctOrientation: true, destinationType: Camera.DestinationType.FILE_URI, saveToPhotoAlbum: false});
                    function onSuccess(imageURI) {
                        var imagen = document.getElementById('images');
                        $('#images').show();
                        document.getElementById('fotoAnimalLocal').value = imageURI + '';
                        //imagen.src = "datos: image/jpeg;base64," + imageData;
                        imagen.src = imageURI;
                        navigator.camera.cleanup(onSuccessEliminar, onFailElimainar);
                    }
                    function onFail(message) {
                        alert('Adicione uma foto ja tirada');
                    }
                    function onSuccessEliminar() {
                    }
                    function onFailElimainar(message) {
                    }
                } else {
                    alert('Adicione uma foto ja tirada');
                }
            }
            $("#adicionarRegistro").submit(function (e) {
                var url = "";
                try {
                    json = JSON.parse(localStorage.getItem('servidor'));
                    url = json.ip;
                } catch (e) {
                    url = 'localhost';
                }
                e.preventDefault();
                $.ajax({
                    type: "POST",
                    url: "http://" + url + "/JavaliMS/registro_animal.php",
                    data: $("#adicionarRegistro"),
                    async: false,
                    dataType: "json",
                    success: function (json) {
                        alert(json.msg);
                        if (json.msg == 'Registro Adicionado') {
                            alert("sucesso");
                            open('index.html');
                        }
                        if (json.msg == 'Registro não Adicionado') {
                            alert('Erro no Registro');
                        }
                    }

                    , error: function (xhr, ee, t) {
                        console.log(xhr.responseText);
                        alert('Erro!');
                        if (conexao == 'No network connection' || conexao == 'Unknown connection') {
                            var db = window.openDatabase('javalimsbd', '1.0', 'Banco de Dados', 200000);
                            db.transaction(inserirRegistroBD, errorInserirRegistroCB, sucessInserirRegistroCB);
                            function inserirRegistroBD(tx) {
                                coord = document.getElementById('registroAnimalGeoReferenciaCoordenadas').value;
                                cidade = document.getElementById('registroAnimalGeoReferenciaCidade').value;
                                bairro = document.getElementById('registroAnimalGeoReferenciaBairro').value;
                                rua = document.getElementById('registroAnimalGeoReferenciaRua').value;
                                numero = document.getElementById('registroAnimalGeoReferenciaNumero').value;
                                //registroAnimalGeoReferencia = document.getElementById('registroAnimalGeoReferencia').value;
                                dataHora = document.getElementById('dataHora').value;
                                obs = document.getElementById('obs').value;
                                fotoAnimalLocal = document.getElementById('fotoAnimalLocal').value;
                                qtd = document.getElementById('qtd').value;
                                sexoAnimal = document.getElementById('registroAnimalSexo').value;
                                AnimalTempoVida = document.getElementById('registroAnimalTempoVida').value;
                                animalId = document.getElementById('animal_animalId').value;
                                situacoes = document.getElementById('situacoes').value;
                                alert('\nCoordenadas: ' + coord + '\ncidade' + bairro + '\nbairro' + rua + '\nRua' + numero +
                                        '\nNumero' + dataHora + '\nData e Hora' + obs + 'Obs: ' + fotoAnimalLocal + '\nQuantidade' + qtd +
                                        '\nSexo: ' + sexoAnimal + '\nTempo de Vida: ' + AnimalTempoVida + '\nAnimal: ' + animalId + '\nSituacão: ' + situacoes);
                                //tx.executeSql('INSERT INTO registros(registroAnimalGeoReferencia, registroAnimalDataHora, registroAnimalObs, registroAnimalFoto, registroAnimalQtd, registroAnimalSexo, registroAnimalTempoVida, usuarioEmail, animal, situacaoAnimal) VALUES ("")');
                            }
                            function errorInserirRegistroCB(err) {
                                if (err.code != 0) {
                                    alert('Error processing SQL ' + err.code);
                                }
                            }
                            function sucessInserirRegistroCB() {
                                alert('O registro será concluido quando estiver disponivel uma conexão de rede');
                            }
                        }
                    }
                });
            });</script>
        <script type="text/javascript" src="js/jquery-2.1.3.min.js"></script>
        <script type="text/javascript" src="js/materialize.min.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script type="text/javascript" src="js/cordova.js"></script>
        <script type="text/javascript" src="script.js"></script>
        <script type="text/javascript" src="js/script.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyASbBnu9NjJ5HB4OD8un7QHbiFg3XUAiBQ" type="text/javascript"></script>
    </body>
</html>